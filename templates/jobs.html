{% extends "base.html" %}

{% block title %}Jobs de Scraping{% endblock %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12 mb-4">
            <h2>Jobs de Scraping</h2>
            <p class="text-muted">Acompanhe o progresso dos seus jobs de scraping.</p>
        </div>
    </div>

    {% if jobs %}
    <div class="job-grid">
        {% for job in jobs %}
        <div class="card job-card" data-job-id="{{ job.id }}">
            <div class="job-header">
                <div class="job-title">
                    <span class="job-keyword">{{ job.keyword }}</span>
                    <span class="job-date">{{ job.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
                <div class="job-status">
                    {% if job.status == 'pending' %}
                    <span class="badge"
                        style="background: rgba(255, 209, 102, 0.2); color: #ffd166; border: 1px solid rgba(255, 209, 102, 0.3);">Pendente</span>
                    {% elif job.status == 'running' %}
                    <span class="badge"
                        style="background: rgba(79, 124, 255, 0.2); color: #4f7cff; border: 1px solid rgba(79, 124, 255, 0.3);">Executando</span>
                    {% elif job.status == 'completed' %}
                    <span class="badge"
                        style="background: rgba(25, 195, 125, 0.2); color: #19c37d; border: 1px solid rgba(25, 195, 125, 0.3);">Concluído</span>
                    {% elif job.status == 'failed' %}
                    <span class="badge"
                        style="background: rgba(255, 93, 93, 0.2); color: #ff5d5d; border: 1px solid rgba(255, 93, 93, 0.3);">Falhou</span>
                    {% endif %}
                </div>
            </div>

            <div class="job-details">
                <div class="detail-item">
                    <span class="detail-label">Localizações:</span>
                    <span class="detail-value">{{ job.locations_count }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Leads:</span>
                    <span class="detail-value">{{ job.lead_count }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Atual:</span>
                    <span class="detail-value text-truncate" title="{{ job.current_location }}">{{ job.current_location
                        or '-' }}</span>
                </div>
            </div>

            {% if job.status == 'running' %}
            <div class="job-progress">
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" style="width: {{ job.progress }}%"
                        aria-valuenow="{{ job.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="progress-info">
                    <span>{{ job.progress }}%</span>
                </div>
            </div>
            {% endif %}

            <div class="job-actions">
                {% if job.status == 'running' or job.status == 'pending' %}
                <button class="btn btn-sm btn-outline-primary" onclick="refreshJob({{ job.id }});"
                    title="Atualizar Status">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                {% endif %}

                {% if job.status == 'completed' and job.results_path %}
                <a class="btn btn-sm btn-success" href="/download?path={{ job.results_path }}" title="Baixar CSV">
                    <i class="fas fa-download"></i> CSV
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Nenhum job de scraping encontrado.
        <a href="/" class="alert-link">Inicie um novo scraping</a>.
    </div>
    {% endif %}
</div>

<style>
    .job-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .job-card {
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .job-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.15);
    }

    .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .job-title {
        display: flex;
        flex-direction: column;
    }

    .job-keyword {
        font-weight: 700;
        font-size: 18px;
        color: var(--text);
    }

    .job-date {
        font-size: 12px;
        color: var(--muted);
    }

    .job-details {
        display: grid;
        gap: 4px;
        font-size: 14px;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
    }

    .detail-label {
        color: var(--muted);
    }

    .detail-value {
        font-weight: 500;
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
    }

    .job-progress {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .progress-info {
        font-size: 12px;
        text-align: right;
        color: var(--muted);
    }

    .job-actions {
        margin-top: auto;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding-top: 16px;
    }

    .btn-outline-primary {
        color: var(--primary);
        border-color: var(--primary);
    }

    .btn-outline-primary:hover {
        background: var(--primary);
        color: white;
    }

    .btn-success {
        background: var(--success);
        border: none;
    }
</style>

<style>
    /* Removed unused dropdown styles */
</style>

<script>
    function refreshJob(jobId) {
        fetch(`/api/job/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed' || data.status === 'failed') {
                    location.reload();
                } else {
                    // Update progress bar
                    const card = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
                    if (card) {
                        const progressBar = card.querySelector('.progress-bar');
                        const progressInfo = card.querySelector('.progress-info span');

                        if (progressBar) {
                            progressBar.style.width = data.progress + '%';
                            progressBar.setAttribute('aria-valuenow', data.progress);
                        }
                        if (progressInfo) {
                            progressInfo.textContent = data.progress + '%';
                        }

                        // Check status change
                        const currentBadge = card.querySelector('.badge');
                        // If status changed meaningfully (e.g. from pending to running), reload or update badge
                        // Simple approach: reload if status string differs from current UI class logic
                        // But for now, just auto-refresh handles text, detailed changes reload page
                        if (data.status !== 'running' && data.status !== 'pending') {
                            location.reload();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Erro ao atualizar job:', error);
            });
    }

    // Auto-refresh running jobs every 5 seconds
    document.addEventListener('DOMContentLoaded', function () {
        setInterval(() => {
            const runningCards = document.querySelectorAll('.job-card');
            runningCards.forEach(card => {
                const badge = card.querySelector('.badge');
                if (badge && (badge.textContent.includes('Executando') || badge.textContent.includes('Pendente'))) {
                    const id = card.getAttribute('data-job-id');
                    if (id) refreshJob(id);
                }
            });
        }, 5000);
    });
</script>
{% endblock %}