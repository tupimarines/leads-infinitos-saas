{% extends "base.html" %}

{% block title %}WhatsApp - Leads Infinitos{% endblock %}

{% block body %}
<div class="section">
    <div class="container">
        <div class="hero" style="text-align: left; padding: 0 0 40px;">
            <h1>Configuração do WhatsApp</h1>
            <p>Conecte sua{% if is_super_admin %}s instância{% if instances|length > 1 %}s{% endif %}{% else %} instância{% endif %} para disparar mensagens automáticas.</p>
        </div>

        {% if is_super_admin %}
        <!-- ====================== SUPER ADMIN: MULTI-INSTANCE VIEW ====================== -->
        
        <!-- Add New Instance Form (collapsible) -->
        <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleAddForm()">
                <h3 style="margin: 0; font-size: 18px;">➕ Adicionar Nova Instância</h3>
                <span id="add-form-arrow" style="font-size: 14px; color: var(--muted); transition: transform 0.3s;">▼</span>
            </div>
            <div id="add-instance-form" style="display: none; margin-top: 20px;">
                <div class="field" style="margin-bottom: 16px;">
                    <label>Nome da Instância</label>
                    <input type="text" id="new_instance_name" placeholder="Ex: whatsapp-02">
                    <p class="muted" style="font-size: 12px; margin-top: 4px;">Um nome único para identificar esta conexão.</p>
                </div>
                <button class="btn btn-primary" onclick="createInstance()">Criar Instância</button>
                <div id="add-message-area" style="margin-top: 12px; display: none;"></div>
            </div>
        </div>
        
        <!-- Instances List -->
        <div id="instances-container">
        {% if instances %}
            {% for inst in instances %}
            <div class="card instance-card" data-instance-key="{{ inst.apikey }}" data-instance-id="{{ inst.id }}" style="padding: 24px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <div>
                        <h3 style="margin: 0; font-size: 18px;">{{ inst.name }}</h3>
                        <p class="muted" style="font-size: 12px; margin-top: 4px;">ID: {{ inst.id }} · Key: {{ inst.apikey[:20] if inst.apikey else 'N/A' }}...</p>
                    </div>
                    <div class="badge instance-status-badge" data-instance-name="{{ inst.name }}"
                        style="{% if inst.status == 'connected' %}background: rgba(25, 195, 125, 0.12); color: #19c37d; border-color: rgba(25, 195, 125, 0.35);{% else %}background: rgba(255, 93, 93, 0.12); color: #ff5d5d; border-color: rgba(255, 93, 93, 0.35);{% endif %}">
                        {{ 'Conectado' if inst.status == 'connected' else 'Desconectado' }}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="getQrCode('{{ inst.apikey }}')" {% if not inst.apikey %}disabled style="opacity: 0.5;"{% endif %}>
                        QR Code
                    </button>
                    <button class="btn" onclick="checkInstanceStatus('{{ inst.apikey }}', '{{ inst.name }}')">
                        Status
                    </button>
                    <button class="btn" onclick="restartSingleInstance('{{ inst.apikey }}')">
                        Reiniciar
                    </button>
                    <button class="btn" onclick="deleteSingleInstance('{{ inst.apikey }}')"
                        style="background: rgba(255,93,93,.12); color: #ff5d5d; border-color: rgba(255,93,93,.35);">
                        Deletar
                    </button>
                </div>
                
                <div class="instance-message-area" style="margin-top: 12px; display: none;"></div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card" style="padding: 30px; text-align: center;">
                <p class="muted">Nenhuma instância configurada. Crie uma acima para começar.</p>
            </div>
        {% endif %}
        </div>

        <!-- QR Code Display (shared, floating) -->
        <div id="qr-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center;">
            <div class="card" style="padding: 30px; max-width: 350px; text-align: center; position: relative;">
                <button onclick="closeQrModal()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--muted); cursor: pointer; font-size: 18px;">✕</button>
                <h3 style="margin-top: 0;">QR Code de Conexão</h3>
                <p class="muted" style="margin-bottom: 16px;">Escaneie com seu WhatsApp</p>
                <div id="qr-container" style="background: white; padding: 16px; border-radius: 12px; min-height: 250px; display: flex; align-items: center; justify-content: center;">
                    <span class="muted">Carregando...</span>
                </div>
            </div>
        </div>

        <script>
            function toggleAddForm() {
                const form = document.getElementById('add-instance-form');
                const arrow = document.getElementById('add-form-arrow');
                if (form.style.display === 'none') {
                    form.style.display = 'block';
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    form.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }

            function showCardMessage(card, msg, type = 'info') {
                const area = card.querySelector('.instance-message-area');
                if (!area) return;
                area.style.display = 'block';
                area.style.borderRadius = '8px';
                area.style.padding = '10px 14px';
                area.style.fontSize = '13px';
                area.style.borderColor = type === 'error' ? 'rgba(255,93,93,.35)' : 'rgba(25, 195, 125, 0.35)';
                area.style.background = type === 'error' ? 'rgba(255,93,93,.12)' : 'rgba(25, 195, 125, 0.12)';
                area.style.color = type === 'error' ? '#ffd4d4' : '#d4ffeb';
                area.style.border = `1px solid ${area.style.borderColor}`;
                area.innerText = msg;
                setTimeout(() => { area.style.display = 'none'; }, 5000);
            }

            function findCardByKey(apikey) {
                return document.querySelector(`.instance-card[data-instance-key="${apikey}"]`);
            }

            async function createInstance() {
                const name = document.getElementById('new_instance_name').value;
                const msgArea = document.getElementById('add-message-area');
                if (!name) {
                    msgArea.style.display = 'block';
                    msgArea.innerText = 'Digite um nome para a instância.';
                    msgArea.style.color = '#ff5d5d';
                    return;
                }

                try {
                    const res = await fetch('/api/whatsapp/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instance_name: name })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    msgArea.style.display = 'block';
                    msgArea.innerText = 'Instância criada! Recarregando...';
                    msgArea.style.color = '#19c37d';
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    msgArea.style.display = 'block';
                    msgArea.innerText = e.message;
                    msgArea.style.color = '#ff5d5d';
                }
            }

            function closeQrModal() {
                document.getElementById('qr-modal').style.display = 'none';
            }

            async function getQrCode(apikey) {
                const modal = document.getElementById('qr-modal');
                const container = document.getElementById('qr-container');
                modal.style.display = 'flex';
                container.innerHTML = '<span class="muted">Carregando...</span>';

                try {
                    const res = await fetch(`/api/whatsapp/qr/${apikey}`);
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    let base64Img = data.base64 || data.qrcode;
                    if (base64Img) {
                        base64Img = base64Img.replace('data:image/png;base64,', '');
                        container.innerHTML = `<img src="data:image/png;base64,${base64Img}" style="width:100%;height:100%;object-fit:contain;">`;
                    } else {
                        throw new Error('QR Code não recebido.');
                    }
                } catch (e) {
                    container.innerHTML = `<span style="color: #ff5d5d;">${e.message}</span>`;
                }
            }

            async function checkInstanceStatus(apikey, instanceName) {
                const card = findCardByKey(apikey);
                try {
                    const res = await fetch(`/api/whatsapp/status/${apikey}`);
                    const data = await res.json();

                    let isConnected = false;
                    if (data.instance && data.instance.status === 'connected') isConnected = true;
                    else if (data.instance_data && (data.instance_data.phone_connected || data.instance_data.status === 'open')) isConnected = true;
                    else if (data.phone_connected === true) isConnected = true;
                    else if (data.status === 'CONNECTED' || data.status === 'open') isConnected = true;

                    // Update badge
                    const badge = card.querySelector('.instance-status-badge');
                    if (isConnected) {
                        badge.innerText = 'Conectado';
                        badge.style.background = 'rgba(25, 195, 125, 0.12)';
                        badge.style.color = '#19c37d';
                        badge.style.borderColor = 'rgba(25, 195, 125, 0.35)';
                        showCardMessage(card, 'Conexão ativa!', 'success');
                    } else {
                        badge.innerText = 'Desconectado';
                        badge.style.background = 'rgba(255, 93, 93, 0.12)';
                        badge.style.color = '#ff5d5d';
                        badge.style.borderColor = 'rgba(255, 93, 93, 0.35)';
                        showCardMessage(card, 'Instância desconectada.', 'error');
                    }
                } catch (e) {
                    if (card) showCardMessage(card, 'Erro ao verificar status.', 'error');
                }
            }

            async function restartSingleInstance(apikey) {
                const card = findCardByKey(apikey);
                if (!confirm('Deseja reiniciar esta instância?')) return;

                try {
                    const res = await fetch(`/api/whatsapp/restart/${apikey}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    showCardMessage(card, 'Reiniciada! Verificando status...', 'success');
                    setTimeout(() => checkInstanceStatus(apikey, ''), 3000);
                } catch (e) {
                    showCardMessage(card, e.message, 'error');
                }
            }

            async function deleteSingleInstance(apikey) {
                if (!confirm('⚠️ ATENÇÃO: Deseja realmente DELETAR esta instância?\n\nEsta ação removerá a instância permanentemente.')) return;
                
                const card = findCardByKey(apikey);
                try {
                    const res = await fetch(`/api/whatsapp/delete/${apikey}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    showCardMessage(card, 'Deletada! Recarregando...', 'success');
                    setTimeout(() => location.reload(), 1500);
                } catch (e) {
                    showCardMessage(card, e.message, 'error');
                }
            }
        </script>

        {% else %}
        <!-- ====================== NORMAL USER: SINGLE-INSTANCE VIEW ====================== -->
        <div class="grid grid-2">
            <!-- Configuration Card -->
            <div class="card" style="padding: 30px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                    <h3 style="margin: 0; font-size: 20px;">Sua Instância</h3>
                    <div id="status-badge" class="badge"
                        style="background: rgba(255, 93, 93, 0.12); color: #ff5d5d; border-color: rgba(255, 93, 93, 0.35);">
                        Desconectado
                    </div>
                </div>

                <div class="field" style="margin-bottom: 20px;">
                    <label>Nome da Instância</label>
                    <input type="text" id="instance_name" placeholder="Ex: minha-loja-01"
                        value="{{ instance.name if instance else '' }}" {% if instance and instance.status=='connected'
                        %}readonly{% endif %}>
                    <p class="muted" style="font-size: 12px; margin-top: 4px;">Um nome único para identificar sua
                        conexão.</p>
                </div>

                <div class="field" style="margin-bottom: 20px;">
                    <label>Chave da API (Gerada Automaticamente)</label>
                    <input type="text" id="instance_key" value="{{ instance.apikey if instance else '' }}" readonly
                        placeholder="Será gerada após criar a instância" style="opacity: 0.7; cursor: not-allowed;">
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="btn-create" class="btn btn-primary" onclick="createInstance()" {% if instance and
                        instance.status=='connected' %}disabled style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                        {% if instance %}Configurar{% else %}Criar Instância{% endif %}
                    </button>
                    <button id="btn-qr" class="btn" onclick="getQrCode()" {% if not instance %}disabled
                        style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                        Gerar QR Code
                    </button>
                    <button id="btn-status" class="btn" onclick="checkStatus()" {% if not instance %}disabled
                        style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                        Verificar Status
                    </button>
                    <button id="btn-restart" class="btn" onclick="restartInstance()" {% if not instance %}disabled
                        style="opacity: 0.5; cursor: not-allowed;" {% endif %}>
                        Reiniciar Conexão
                    </button>
                    <button id="btn-delete" class="btn" onclick="deleteInstance()" {% if not instance %}disabled
                        style="opacity: 0.5; cursor: not-allowed; background: rgba(255,93,93,.12); color: #ff5d5d; border-color: rgba(255,93,93,.35);"
                        {% else
                        %}style="background: rgba(255,93,93,.12); color: #ff5d5d; border-color: rgba(255,93,93,.35);" {%
                        endif %}>
                        Deletar Instância
                    </button>
                </div>

                <div id="message-area" style="margin-top: 20px; display: none;"></div>
            </div>

            <!-- QR Code Display -->
            <div class="card"
                style="padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px;">
                <h3 style="margin-top: 0;">QR Code de Conexão</h3>
                <p class="muted" style="text-align: center; margin-bottom: 24px;">Escaneie o código abaixo com o seu
                    WhatsApp para conectar.</p>

                <div id="qr-container"
                    style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; width: 250px; height: 250px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                    <span class="muted" style="color: rgba(255,255,255,0.3);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        <br>Aguardando...
                    </span>
                </div>

                <div id="loading" style="display: none; margin-top: 20px; color: var(--primary);">
                    Carregando...
                </div>
            </div>
        </div>

        <script>
            const statusBadge = document.getElementById('status-badge');
            const qrContainer = document.getElementById('qr-container');
            const msgArea = document.getElementById('message-area');

            const currentStatus = "{{ instance.status if instance else 'disconnected' }}";
            updateStatusUI(currentStatus);

            function showMessage(msg, type = 'info') {
                msgArea.style.display = 'block';
                msgArea.className = 'flash';
                msgArea.style.borderColor = type === 'error' ? 'rgba(255,93,93,.35)' : 'rgba(25, 195, 125, 0.35)';
                msgArea.style.background = type === 'error' ? 'rgba(255,93,93,.12)' : 'rgba(25, 195, 125, 0.12)';
                msgArea.style.color = type === 'error' ? '#ffd4d4' : '#d4ffeb';
                msgArea.innerText = msg;
            }

            function updateStatusUI(status) {
                if (status === 'connected' || status === 'open') {
                    statusBadge.innerText = "Conectado";
                    statusBadge.style.background = "rgba(25, 195, 125, 0.12)";
                    statusBadge.style.color = "#19c37d";
                    statusBadge.style.borderColor = "rgba(25, 195, 125, 0.35)";
                } else {
                    statusBadge.innerText = "Desconectado";
                    statusBadge.style.background = "rgba(255, 93, 93, 0.12)";
                    statusBadge.style.color = "#ff5d5d";
                    statusBadge.style.borderColor = "rgba(255, 93, 93, 0.35)";
                }
            }

            async function createInstance() {
                const name = document.getElementById('instance_name').value;
                if (!name) return showMessage('Digite um nome para a instância.', 'error');

                document.getElementById('btn-create').disabled = true;
                document.getElementById('loading').style.display = 'block';

                try {
                    const res = await fetch('/api/whatsapp/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instance_name: name })
                    });
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    showMessage('Instância criada com sucesso! Agora gere o QR Code.', 'success');
                    document.getElementById('instance_key').value = data.key;
                    document.getElementById('btn-qr').disabled = false;
                    document.getElementById('btn-status').disabled = false;

                    setTimeout(() => location.reload(), 1500);

                } catch (e) {
                    showMessage(e.message, 'error');
                    document.getElementById('btn-create').disabled = false;
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async function getQrCode() {
                const key = document.getElementById('instance_key').value;
                if (!key) return showMessage('Instância não configurada.', 'error');

                document.getElementById('loading').style.display = 'block';
                qrContainer.innerHTML = '';

                try {
                    const res = await fetch(`/api/whatsapp/qr/${key}`);
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    let base64Img = data.base64 || data.qrcode;

                    if (base64Img) {
                        base64Img = base64Img.replace('data:image/png;base64,', '');
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${base64Img}`;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'contain';
                        qrContainer.style.background = 'white';
                        qrContainer.appendChild(img);
                    } else {
                        throw new Error('QR Code não recebido da API.');
                    }

                } catch (e) {
                    showMessage(e.message, 'error');
                    qrContainer.innerHTML = '<span class="muted">Erro ao carregar</span>';
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async function checkStatus() {
                const key = document.getElementById('instance_key').value;
                if (!key) return;

                try {
                    const res = await fetch(`/api/whatsapp/status/${key}`);
                    const data = await res.json();

                    let isConnected = false;
                    if (data.instance && data.instance.status === 'connected') isConnected = true;
                    else if (data.instance_data && (data.instance_data.phone_connected || data.instance_data.status === 'open')) isConnected = true;
                    else if (data.phone_connected === true) isConnected = true;
                    else if (data.status === 'CONNECTED' || data.status === 'open') isConnected = true;

                    updateStatusUI(isConnected ? 'connected' : 'disconnected');

                    if (isConnected) {
                        showMessage('Conexão ativa!', 'success');
                        qrContainer.innerHTML = '<div style="color: #19c37d; font-size: 40px;">✓</div>';
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessage('Instância desconectada.', 'error');
                    }

                } catch (e) {
                    showMessage('Erro ao verificar status.', 'error');
                }
            }

            async function restartInstance() {
                const key = document.getElementById('instance_key').value;
                if (!key) return showMessage('Instância não configurada.', 'error');

                if (!confirm('Deseja reiniciar a conexão da instância?')) return;

                document.getElementById('btn-restart').disabled = true;
                document.getElementById('loading').style.display = 'block';

                try {
                    const res = await fetch(`/api/whatsapp/restart/${key}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    showMessage('Conexão reiniciada! Aguarde e verifique o status.', 'success');
                    setTimeout(() => checkStatus(), 3000);

                } catch (e) {
                    showMessage(e.message || 'Erro ao reiniciar conexão.', 'error');
                } finally {
                    document.getElementById('btn-restart').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async function deleteInstance() {
                const key = document.getElementById('instance_key').value;
                if (!key) return showMessage('Instância não configurada.', 'error');

                if (!confirm('⚠️ ATENÇÃO: Deseja realmente DELETAR esta instância?\n\nEsta ação removerá a instância permanentemente.')) return;

                document.getElementById('btn-delete').disabled = true;
                document.getElementById('loading').style.display = 'block';

                try {
                    const res = await fetch(`/api/whatsapp/delete/${key}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    showMessage('Instância deletada! Recarregando...', 'success');
                    setTimeout(() => location.reload(), 2000);

                } catch (e) {
                    showMessage(e.message || 'Erro ao deletar instância.', 'error');
                    document.getElementById('btn-delete').disabled = false;
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}