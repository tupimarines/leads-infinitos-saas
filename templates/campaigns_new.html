{% extends "base.html" %}

{% block title %}Nova Campanha - Leads Infinitos{% endblock %}

{% block extra_head %}
<!-- Tailwind CSS (via CDN for rapid dev) -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    bg: '#0b1020',
                    card: '#0f1630',
                    primary: '#4f7cff',
                    accent: '#8b5cf6',
                }
            }
        }
    }
</script>
<style>
    /* Custom Neon/Glass Effects */
    .glass-panel {
        background: rgba(15, 22, 48, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .neon-input {
        background: rgba(12, 20, 48, 0.8);
        border: 1px solid rgba(79, 124, 255, 0.3);
        box-shadow: 0 0 10px rgba(79, 124, 255, 0.05);
        transition: all 0.3s ease;
    }

    .neon-input:focus {
        border-color: #4f7cff;
        box-shadow: 0 0 15px rgba(79, 124, 255, 0.3);
        outline: none;
    }

    .btn-cyber {
        background: linear-gradient(90deg, #4f7cff, #8b5cf6);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        letter-spacing: 1px;
        font-weight: 700;
        border: none;
    }

    .btn-cyber::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        transition: 0.5s;
    }

    .btn-cyber:hover::before {
        left: 100%;
    }

    .btn-cyber:hover {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
        transform: translateY(-2px);
    }

    /* Override base styles if needed */
    h1,
    h2,
    h3 {
        color: #e8ecf6;
    }

    /* Cadence Accordion */
    .cadence-step {
        border: 1px solid rgba(79, 124, 255, 0.15);
        background: rgba(12, 20, 48, 0.5);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .cadence-step.active {
        border-color: rgba(79, 124, 255, 0.4);
        box-shadow: 0 0 20px rgba(79, 124, 255, 0.08);
    }

    .cadence-step-header {
        cursor: pointer;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .cadence-step-header:hover {
        background: rgba(79, 124, 255, 0.05);
    }

    .cadence-step-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s ease;
    }

    .cadence-step-body.open {
        max-height: 600px;
    }

    .cadence-step-body-inner {
        padding: 0 16px 16px;
    }

    .step-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        padding: 2px 10px;
        border-radius: 9999px;
        font-weight: 600;
    }

    .media-preview {
        max-width: 120px;
        max-height: 80px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        object-fit: cover;
    }

    .terms-card {
        background: rgba(234, 179, 8, 0.06);
        border: 1px solid rgba(234, 179, 8, 0.25);
        border-radius: 12px;
    }

    .cadence-toggle-track {
        width: 44px;
        height: 24px;
        background: #374151;
        border-radius: 9999px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
    }

    .cadence-toggle-track.on {
        background: linear-gradient(90deg, #4f7cff, #8b5cf6);
    }

    .cadence-toggle-thumb {
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .cadence-toggle-track.on .cadence-toggle-thumb {
        transform: translateX(20px);
    }
</style>
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-12">
    <div class="max-w-3xl mx-auto">

        <div class="mb-8 text-center">
            <h1
                class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                Nova Campanha
            </h1>
            <p class="text-gray-400">Configure o disparo em massa para seus leads extra√≠dos.</p>
        </div>

        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden">
            <!-- decorative blurred blob -->
            <div
                class="absolute -top-20 -right-20 w-64 h-64 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-blob">
            </div>

            <form id="campaignForm" class="space-y-6 relative z-10">

                <!-- Nome da Campanha -->
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Nome da Campanha</label>
                    <input type="text" id="name" placeholder="Ex: Prospec√ß√£o Dentistas SP" required
                        class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600">
                </div>

                <!-- Sele√ß√£o de Lista (Job) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Lista de Leads (Extra√ß√£o)</label>
                    <div class="relative">
                        <select id="job_id" required
                            class="neon-input w-full px-4 py-3 rounded-xl text-white appearance-none cursor-pointer">
                            <option value="" disabled selected>Carregando extra√ß√µes...</option>
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400">
                            <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                                <path
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                            </svg>
                        </div>
                    </div>
                    <p id="jobStats" class="text-xs text-blue-400 mt-2 hidden"></p>

                    <!-- Upload CSV Option -->
                    <div class="mt-3 flex justify-end">
                        <input type="file" id="csvUpload" accept=".csv" class="hidden">
                        <button type="button" id="uploadCsvBtn"
                            class="text-xs flex items-center gap-1 text-purple-400 hover:text-purple-300 transition-colors border border-purple-500/30 px-3 py-1.5 rounded-lg bg-purple-500/10 hover:bg-purple-500/20">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Envie sua pr√≥pria lista
                        </button>
                    </div>


                </div>

                <!-- Campo de Contexto do Neg√≥cio (Para IA) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">
                        Fale sobre seu neg√≥cio
                        <span class="text-xs font-normal text-gray-500 ml-2">(Usado pela IA para gerar mensagens)</span>
                    </label>
                    <textarea id="business_context" rows="3"
                        placeholder="Ex: Sou dentista em S√£o Paulo. Oferecemos limpeza, clareamento e aparelhos ortod√¥nticos com pre√ßos justos..."
                        class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600"></textarea>
                </div>

                <!-- Templates de Mensagem -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold text-gray-300">
                            Mensagem <span class="text-xs font-normal text-gray-500 ml-2">(Use {nome} para
                                personalizar)</span>
                        </label>
                        <div class="flex gap-2">
                            <select id="loadTemplateSelect"
                                class="text-xs bg-gray-800 text-gray-300 px-2 py-1 rounded border border-gray-600 focus:border-primary focus:outline-none">
                                <option value="">üìÇ Carregar Modelo...</option>
                            </select>
                            <button type="button" id="mainAIBtn"
                                class="text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded border border-purple-500/30 hover:bg-purple-600/40 transition-colors flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Criar com IA
                            </button>
                        </div>
                    </div>

                    <div id="templates-container" class="space-y-3">
                        <!-- Template 1 (Default) - sem wrapper para n√£o ter bot√£o X -->
                        <textarea name="message_template" rows="4" required
                            placeholder="Ol√° {nome}, vi sua empresa no Google Maps e..."
                            class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600 template-input"></textarea>
                    </div>

                    <div class="mt-2 flex justify-between items-center">
                        <button type="button" id="addTemplateBtn"
                            class="text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Adicionar varia√ß√£o (Spin)
                        </button>

                        <button type="button" id="saveTemplateBtn"
                            class="text-xs text-gray-400 hover:text-white flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4">
                                </path>
                            </svg>
                            Salvar como Modelo
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Adicione at√© 5 varia√ß√µes para rotacionar o envio e evitar
                        bloqueios.</p>
                </div>

                <!-- ============================================ -->
                <!-- CADENCE TOGGLE -->
                <!-- ============================================ -->
                <div class="glass-panel p-5 rounded-xl"
                    style="background: rgba(139, 92, 246, 0.04); border: 1px solid rgba(139, 92, 246, 0.2);">
                    <div class="flex justify-between items-center">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300">
                                üîÑ Cad√™ncia de Follow-up
                            </label>
                            <p class="text-xs text-gray-500 mt-1">Ative para enviar mensagens de acompanhamento
                                automaticamente</p>
                        </div>
                        <div class="cadence-toggle-track" id="cadenceToggle" onclick="toggleCadence()">
                            <div class="cadence-toggle-thumb"></div>
                        </div>
                    </div>
                    <input type="hidden" id="enable_cadence" value="false">
                </div>

                <!-- ============================================ -->
                <!-- CADENCE STEPS (hidden by default) -->
                <!-- ============================================ -->
                <div id="cadenceStepsContainer" class="space-y-3" style="display: none;">

                    <!-- Step 1: Mensagem Inicial -->
                    <div class="cadence-step active" data-step="1">
                        <div class="cadence-step-header" onclick="toggleStep(1)">
                            <div class="flex items-center gap-3">
                                <span class="step-badge bg-blue-500/20 text-blue-400 border border-blue-500/30">Etapa
                                    1</span>
                                <span class="text-sm font-semibold text-gray-200">Mensagem Inicial</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Dia 0</span>
                                <svg class="w-4 h-4 text-gray-400 transition-transform step-chevron" data-step="1"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="cadence-step-body open" data-step-body="1">
                            <div class="cadence-step-body-inner space-y-3">
                                <p class="text-xs text-gray-500">Primeira mensagem de prospec√ß√£o. Usa os templates
                                    configurados acima.</p>
                                <div class="flex items-center gap-3">
                                    <label class="text-xs text-gray-400">M√≠dia (opcional):</label>
                                    <input type="file" id="media_step_1" accept="image/*,video/*" class="hidden"
                                        onchange="handleMediaUpload(1, this)">
                                    <button type="button" onclick="document.getElementById('media_step_1').click()"
                                        class="text-xs bg-gray-700/50 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600/50 hover:bg-gray-700 transition-colors flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Anexar imagem/v√≠deo
                                    </button>
                                    <div id="mediaPreview_1" class="hidden flex items-center gap-2">
                                        <img id="mediaThumb_1" class="media-preview" src="" alt="">
                                        <button type="button" onclick="removeMedia(1)"
                                            class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                                    </div>
                                </div>
                                <input type="hidden" id="mediaData_1" value="">
                                <input type="hidden" id="mediaName_1" value="">
                                <input type="hidden" id="mediaType_1" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Follow-up 1 -->
                    <div class="cadence-step" data-step="2">
                        <div class="cadence-step-header" onclick="toggleStep(2)">
                            <div class="flex items-center gap-3">
                                <span
                                    class="step-badge bg-purple-500/20 text-purple-400 border border-purple-500/30">Etapa
                                    2</span>
                                <span class="text-sm font-semibold text-gray-200">Follow-up 1</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Dia 3</span>
                                <svg class="w-4 h-4 text-gray-400 transition-transform step-chevron" data-step="2"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="cadence-step-body" data-step-body="2">
                            <div class="cadence-step-body-inner space-y-3">
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <label class="text-xs text-gray-400 mb-1 block">Aguardar (dias) ap√≥s etapa
                                            anterior:</label>
                                        <input type="number" id="delay_step_2" value="3" min="1" max="30"
                                            class="neon-input w-20 px-3 py-2 rounded-lg text-white text-sm text-center">
                                    </div>
                                    <button type="button" onclick="generateCadenceCopy(2)"
                                        class="text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded border border-purple-500/30 hover:bg-purple-600/40 transition-colors flex items-center gap-1 mt-4">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Criar com IA
                                    </button>
                                </div>
                                <textarea id="msg_step_2" rows="3"
                                    placeholder="Ol√° {nome}, te mandei uma mensagem outro dia sobre..."
                                    class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600 text-sm"></textarea>
                                <div class="flex items-center gap-3">
                                    <input type="file" id="media_step_2" accept="image/*,video/*" class="hidden"
                                        onchange="handleMediaUpload(2, this)">
                                    <button type="button" onclick="document.getElementById('media_step_2').click()"
                                        class="text-xs bg-gray-700/50 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600/50 hover:bg-gray-700 transition-colors flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Anexar
                                    </button>
                                    <div id="mediaPreview_2" class="hidden flex items-center gap-2">
                                        <img id="mediaThumb_2" class="media-preview" src="" alt="">
                                        <button type="button" onclick="removeMedia(2)"
                                            class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                                    </div>
                                </div>
                                <input type="hidden" id="mediaData_2" value="">
                                <input type="hidden" id="mediaName_2" value="">
                                <input type="hidden" id="mediaType_2" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Follow-up 2 -->
                    <div class="cadence-step" data-step="3">
                        <div class="cadence-step-header" onclick="toggleStep(3)">
                            <div class="flex items-center gap-3">
                                <span
                                    class="step-badge bg-indigo-500/20 text-indigo-400 border border-indigo-500/30">Etapa
                                    3</span>
                                <span class="text-sm font-semibold text-gray-200">Follow-up 2</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Dia 7</span>
                                <svg class="w-4 h-4 text-gray-400 transition-transform step-chevron" data-step="3"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="cadence-step-body" data-step-body="3">
                            <div class="cadence-step-body-inner space-y-3">
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <label class="text-xs text-gray-400 mb-1 block">Aguardar (dias) ap√≥s etapa
                                            anterior:</label>
                                        <input type="number" id="delay_step_3" value="4" min="1" max="30"
                                            class="neon-input w-20 px-3 py-2 rounded-lg text-white text-sm text-center">
                                    </div>
                                    <button type="button" onclick="generateCadenceCopy(3)"
                                        class="text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded border border-purple-500/30 hover:bg-purple-600/40 transition-colors flex items-center gap-1 mt-4">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Criar com IA
                                    </button>
                                </div>
                                <textarea id="msg_step_3" rows="3"
                                    placeholder="{nome}, tudo bem? Notei que ainda n√£o respondeu..."
                                    class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600 text-sm"></textarea>
                                <div class="flex items-center gap-3">
                                    <input type="file" id="media_step_3" accept="image/*,video/*" class="hidden"
                                        onchange="handleMediaUpload(3, this)">
                                    <button type="button" onclick="document.getElementById('media_step_3').click()"
                                        class="text-xs bg-gray-700/50 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600/50 hover:bg-gray-700 transition-colors flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Anexar
                                    </button>
                                    <div id="mediaPreview_3" class="hidden flex items-center gap-2">
                                        <img id="mediaThumb_3" class="media-preview" src="" alt="">
                                        <button type="button" onclick="removeMedia(3)"
                                            class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                                    </div>
                                </div>
                                <input type="hidden" id="mediaData_3" value="">
                                <input type="hidden" id="mediaName_3" value="">
                                <input type="hidden" id="mediaType_3" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Break-up -->
                    <div class="cadence-step" data-step="4">
                        <div class="cadence-step-header" onclick="toggleStep(4)">
                            <div class="flex items-center gap-3">
                                <span class="step-badge bg-red-500/20 text-red-400 border border-red-500/30">Etapa
                                    4</span>
                                <span class="text-sm font-semibold text-gray-200">Break-up</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">Dia 8</span>
                                <svg class="w-4 h-4 text-gray-400 transition-transform step-chevron" data-step="4"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <div class="cadence-step-body" data-step-body="4">
                            <div class="cadence-step-body-inner space-y-3">
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <label class="text-xs text-gray-400 mb-1 block">Aguardar (dias) ap√≥s etapa
                                            anterior:</label>
                                        <input type="number" id="delay_step_4" value="1" min="1" max="30"
                                            class="neon-input w-20 px-3 py-2 rounded-lg text-white text-sm text-center">
                                    </div>
                                    <button type="button" onclick="generateCadenceCopy(4)"
                                        class="text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded border border-purple-500/30 hover:bg-purple-600/40 transition-colors flex items-center gap-1 mt-4">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Criar com IA
                                    </button>
                                </div>
                                <textarea id="msg_step_4" rows="3"
                                    placeholder="{nome}, como n√£o tive retorno, entendo que talvez n√£o seja o momento..."
                                    class="neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600 text-sm"></textarea>
                                <p class="text-xs text-yellow-500/80">‚ö†Ô∏è √öltima tentativa. Ap√≥s 24h sem resposta, o lead
                                    ser√° marcado como "Perdido".</p>
                                <div class="flex items-center gap-3">
                                    <input type="file" id="media_step_4" accept="image/*,video/*" class="hidden"
                                        onchange="handleMediaUpload(4, this)">
                                    <button type="button" onclick="document.getElementById('media_step_4').click()"
                                        class="text-xs bg-gray-700/50 text-gray-300 px-3 py-1.5 rounded-lg border border-gray-600/50 hover:bg-gray-700 transition-colors flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        Anexar
                                    </button>
                                    <div id="mediaPreview_4" class="hidden flex items-center gap-2">
                                        <img id="mediaThumb_4" class="media-preview" src="" alt="">
                                        <button type="button" onclick="removeMedia(4)"
                                            class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                                    </div>
                                </div>
                                <input type="hidden" id="mediaData_4" value="">
                                <input type="hidden" id="mediaName_4" value="">
                                <input type="hidden" id="mediaType_4" value="">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Agendamento (Visual Only for now) -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">In√≠cio (opcional)</label>
                        <input type="datetime-local" id="scheduled_start"
                            class="neon-input w-full px-4 py-3 rounded-xl text-white text-sm">
                        <p class="text-xs text-gray-500 mt-1">Deixe vazio para iniciar imediatamente</p>
                    </div>
                </div>

                {% if instances|length > 0 %}
                <!-- Sele√ß√£o de Inst√¢ncias (Multi-inst√¢ncia) -->
                <div class="glass-panel p-5 rounded-xl"
                    style="background: rgba(79, 124, 255, 0.04); border: 1px solid rgba(79, 124, 255, 0.15);">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block text-sm font-semibold text-gray-300">
                            üì± Inst√¢ncias de WhatsApp
                            <span class="text-xs font-normal text-blue-400 ml-2">(Multi-inst√¢ncia)</span>
                        </label>
                        {% if is_super_admin %}
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">Rota√ß√£o</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="rotation_toggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer 
                                    peer-checked:after:translate-x-full peer-checked:after:border-white 
                                    after:content-[''] after:absolute after:top-[2px] after:left-[2px] 
                                    after:bg-white after:border-gray-300 after:border after:rounded-full 
                                    after:h-4 after:w-4 after:transition-all 
                                    peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        {% endif %}
                    </div>

                    <div id="instances-checkboxes" class="space-y-2">
                        {% for inst in instances %}
                        <label class="flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors
                            hover:bg-white/5 border border-transparent instance-checkbox-label"
                            data-instance-id="{{ inst.id }}">
                            <input type="checkbox" name="instance_ids" value="{{ inst.id }}"
                                class="instance-checkbox rounded border-gray-600 bg-gray-800 text-blue-600 focus:ring-blue-500 focus:ring-offset-0"
                                {% if instances|length==1 %}checked{% endif %}>
                            <div class="flex-1 flex items-center justify-between">
                                <span class="text-sm text-gray-200">{{ inst.name }}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full
                                    {% if inst.status == 'connected' %}
                                    bg-green-500/10 text-green-400 border border-green-500/30
                                    {% else %}
                                    bg-red-500/10 text-red-400 border border-red-500/30
                                    {% endif %}">
                                    {{ '‚óè Conectado' if inst.status == 'connected' else '‚óã Desconectado' }}
                                </span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>

                    <p id="rotation-info" class="text-xs text-gray-500 mt-2">
                        {% if instances|length > 1 %}
                        Selecione as inst√¢ncias para esta campanha. Ative a rota√ß√£o para alternar entre elas.
                        {% else %}
                        Inst√¢ncia √∫nica selecionada automaticamente.
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                <!-- ============================================ -->
                <!-- TERMS OF RESPONSIBILITY (always visible) -->
                <!-- ============================================ -->
                <div id="termsCard" class="terms-card p-5">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="text-xl">‚ö†Ô∏è</span>
                        <div>
                            <h3 class="text-sm font-bold text-yellow-400">Termos de Responsabilidade</h3>
                            <p class="text-xs text-gray-400 mt-1 leading-relaxed">
                                Ao criar esta campanha, voc√™ declara estar ciente de que:
                            </p>
                        </div>
                    </div>
                    <ul class="text-xs text-gray-400 space-y-2 ml-8 mb-4">
                        <li>‚Ä¢ O envio excessivo de mensagens pode levar ao <strong class="text-yellow-400">bloqueio
                                tempor√°rio ou permanente</strong> do seu n√∫mero de WhatsApp.</li>
                        <li>‚Ä¢ A <strong class="text-yellow-400">responsabilidade pelo uso</strong> da ferramenta √©
                            exclusivamente sua.</li>
                        <li>‚Ä¢ Recomendamos usar mensagens personalizadas e respeitar os limites di√°rios.</li>
                        <li>‚Ä¢ Follow-ups autom√°ticos <strong class="text-yellow-400">param automaticamente</strong> se o
                            lead responder ou for marcado no Chatwoot.</li>
                        <li>‚Ä¢ O Lead's Infinitos n√£o se responsabiliza por bloqueios resultantes do uso da
                            ferramenta.</li>
                    </ul>
                    <label
                        class="flex items-center gap-3 cursor-pointer p-3 rounded-lg bg-yellow-500/5 border border-yellow-500/20">
                        <input type="checkbox" id="termsAccepted"
                            class="rounded border-yellow-500/50 bg-gray-800 text-yellow-500 focus:ring-yellow-500 focus:ring-offset-0">
                        <span class="text-xs text-yellow-300 font-medium">Li e aceito os termos de responsabilidade
                            para disparo de mensagens</span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="pt-4">
                    <button type="submit" id="submitBtn"
                        class="btn-cyber w-full py-4 rounded-xl text-white shadow-lg text-lg flex justify-center items-center gap-2">
                        <span>iniciar campanha</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </button>
                    <p id="feedback" class="text-center mt-4 text-sm font-medium hidden"></p>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    // Fun√ß√£o para gerar copy com IA
    async function generateCopyWithAI(targetTextarea = null) {
        const businessContext = document.getElementById('business_context').value.trim();

        if (!businessContext) {
            alert('Por favor, descreva seu neg√≥cio no campo "Fale sobre seu neg√≥cio" para a IA gerar mensagens personalizadas.');
            document.getElementById('business_context').focus();
            return;
        }

        // Definir qual textarea ser√° preenchido
        let textarea;
        if (targetTextarea) {
            textarea = targetTextarea;
        } else {
            // Procurar √∫ltimo textarea vazio, ou criar novo se todos estiverem cheios
            const allTextareas = Array.from(container.querySelectorAll('.template-input'));
            textarea = allTextareas.find(t => !t.value.trim());

            if (!textarea && allTextareas.length < maxTemplates) {
                // Criar novo textarea
                addBtn.click();
                await new Promise(resolve => setTimeout(resolve, 100));
                const newTextareas = container.querySelectorAll('.template-input');
                textarea = newTextareas[newTextareas.length - 1];
            } else if (!textarea) {
                textarea = allTextareas[allTextareas.length - 1];
            }
        }

        // Loading state
        const originalPlaceholder = textarea.placeholder;
        textarea.disabled = true;
        textarea.placeholder = '‚ú® IA gerando mensagem...';

        try {
            const res = await fetch('/api/ai/generate-copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ business_context: businessContext })
            });

            const data = await res.json();

            if (res.ok && data.message) {
                textarea.value = data.message;
                textarea.placeholder = originalPlaceholder;
                // Breve flash de sucesso
                textarea.style.borderColor = '#10b981';
                setTimeout(() => {
                    textarea.style.borderColor = '';
                }, 1000);
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        } catch (err) {
            alert(`Erro ao gerarcopy: ${err.message}`);
            textarea.placeholder = originalPlaceholder;
        } finally {
            textarea.disabled = false;
        }
    }

    // Gerenciador de Templates
    const container = document.getElementById('templates-container');
    const addBtn = document.getElementById('addTemplateBtn');
    const maxTemplates = 5;

    // Handler para o bot√£o principal "Criar com IA" - usando ID correto
    document.addEventListener('DOMContentLoaded', () => {
        const mainAIBtn = document.getElementById('mainAIBtn');
        if (mainAIBtn) {
            mainAIBtn.addEventListener('click', () => generateCopyWithAI());
        }
    });

    addBtn.addEventListener('click', () => {
        const currentCount = container.querySelectorAll('textarea').length;
        if (currentCount >= maxTemplates) {
            alert('M√°ximo de 5 varia√ß√µes atingido.');
            return;
        }

        // Criar container para textarea + bot√µes
        const wrapper = document.createElement('div');
        wrapper.className = 'relative';

        const newTextarea = document.createElement('textarea');
        newTextarea.rows = 4;
        newTextarea.placeholder = `Varia√ß√£o de mensagem ${currentCount + 1}...`;
        newTextarea.className = 'neon-input w-full px-4 py-3 rounded-xl text-white placeholder-gray-600 template-input animate-fade-in';
        newTextarea.name = 'message_template';

        // Bot√£o X para excluir (acima do bot√£o IA)
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'absolute top-2 right-14 text-xs bg-red-600/20 text-red-300 px-2 py-1 rounded border border-red-500/30 hover:bg-red-600/40 transition-colors flex items-center gap-1';
        deleteBtn.innerHTML = '‚úï';
        deleteBtn.title = 'Excluir varia√ß√£o';
        deleteBtn.addEventListener('click', () => {
            wrapper.remove();
            // Re-habilitar bot√£o adicionar se estava escondido
            const currentCount = container.querySelectorAll('textarea').length;
            if (currentCount < maxTemplates) {
                addBtn.style.display = 'flex';
            }
        });

        // Mini bot√£o IA
        const miniAIBtn = document.createElement('button');
        miniAIBtn.type = 'button';
        miniAIBtn.className = 'absolute top-2 right-2 text-xs bg-purple-600/20 text-purple-300 px-2 py-1 rounded border border-purple-500/30 hover:bg-purple-600/40 transition-colors flex items-center gap-1';
        miniAIBtn.innerHTML = '‚ú® IA';
        miniAIBtn.addEventListener('click', () => generateCopyWithAI(newTextarea));

        wrapper.appendChild(newTextarea);
        wrapper.appendChild(deleteBtn);
        wrapper.appendChild(miniAIBtn);
        container.appendChild(wrapper);

        if (currentCount + 1 >= maxTemplates) {
            addBtn.style.display = 'none';
        }
    });

    // Carregar Jobs (Listas) ao iniciar
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('/api/scraping-jobs');
            const jobs = await res.json();

            const select = document.getElementById('job_id');
            select.innerHTML = '<option value="" disabled selected>Selecione uma lista de leads...</option>';

            if (jobs.length === 0) {
                select.innerHTML += '<option value="" disabled>Nenhuma extra√ß√£o encontrada. Fa√ßa um Job primeiro.</option>';
            }

            jobs.forEach(job => {
                const date = new Date(job.created_at).toLocaleDateString('pt-BR');
                const opt = document.createElement('option');
                opt.value = job.id;
                opt.textContent = `${job.keyword} - ${job.locations} (${job.total_results} leads) - ${date}`;
                opt.dataset.count = job.total_results;
                select.appendChild(opt);
            });

            // Update stats on change
            select.addEventListener('change', (e) => {
                const opt = e.target.selectedOptions[0];
                const count = opt.dataset.count;
                const stats = document.getElementById('jobStats');
                if (count) {
                    stats.textContent = `Aproximadamente ${count} contatos dispon√≠veis nesta lista.`;
                    stats.classList.remove('hidden');
                }
            });

        } catch (err) {
            console.error(err);
            document.getElementById('jobStats').textContent = 'Erro ao carregar listas.';
            document.getElementById('jobStats').classList.remove('hidden');
            document.getElementById('jobStats').classList.add('text-red-400');
        }
    });

    // Handle CSV Upload
    const uploadBtn = document.getElementById('uploadCsvBtn');
    const fileInput = document.getElementById('csvUpload');
    const jobSelect = document.getElementById('job_id');

    uploadBtn.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Basic validation
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            alert('Por favor, selecione um arquivo CSV v√°lido.');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        // Visual feedback
        const originalText = uploadBtn.innerHTML;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = 'Enviando...';

        try {
            const res = await fetch('/api/upload-csv-leads', {
                method: 'POST',
                body: formData
            });

            const json = await res.json();

            if (res.ok) {
                // Success: Add new option to select and select it
                const opt = document.createElement('option');
                opt.value = json.job_id; // The backend should create a virtual job or similar
                opt.textContent = `[Upload] ${file.name} (${json.total_leads} leads)`;
                opt.dataset.count = json.total_leads;
                opt.selected = true;
                jobSelect.appendChild(opt);

                // Trigger change event to update stats
                jobSelect.dispatchEvent(new Event('change'));

                alert('Lista enviada com sucesso!');
            } else {
                throw new Error(json.error || 'Erro ao enviar arquivo');
            }
        } catch (err) {
            console.error(err);
            alert('Erro no upload: ' + err.message);
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
            fileInput.value = ''; // Reset
        }
    });

    // Handle Submit
    document.getElementById('campaignForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const btn = document.getElementById('submitBtn');
        const feedback = document.getElementById('feedback');
        const originalText = btn.innerHTML;

        // Coletar templates
        const templateInputs = document.querySelectorAll('.template-input');
        const messageTemplates = Array.from(templateInputs).map(input => input.value).filter(val => val.trim() !== '');

        if (messageTemplates.length === 0) {
            alert('Digite ao menos uma mensagem.');
            return;
        }

        // Loading State
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            sua campanha ir√° iniciar logo...
        `;
        feedback.classList.add('hidden');

        // NEW: Validate and convert scheduled_start
        let scheduledStartUTC = null;
        const scheduledInput = document.getElementById('scheduled_start');

        if (scheduledInput.value) {
            const scheduledDate = new Date(scheduledInput.value);
            const now = new Date();

            if (scheduledDate <= now) {
                alert('Data de in√≠cio deve ser futura');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            // Convert to UTC ISO string
            scheduledStartUTC = scheduledDate.toISOString();
        }

        const data = {
            name: document.getElementById('name').value,
            job_id: document.getElementById('job_id').value,
            message_templates: messageTemplates, // Envia lista
            scheduled_start: scheduledStartUTC  // Send UTC
        };

        // TERMS: always validate terms checkbox
        if (!document.getElementById('termsAccepted').checked) {
            alert('Aceite os termos de responsabilidade para continuar.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }

        // CADENCE: include cadence data if enabled
        const cadenceEnabled = document.getElementById('enable_cadence').value === 'true';
        if (cadenceEnabled) {

            // Validate at least steps 2-4 have messages
            let missingSteps = [];
            for (let s = 2; s <= 4; s++) {
                const ta = document.getElementById(`msg_step_${s}`);
                if (!ta || !ta.value.trim()) missingSteps.push(s);
            }
            if (missingSteps.length > 0) {
                alert(`Preencha a mensagem das etapas: ${missingSteps.join(', ')}`);
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }

            data.enable_cadence = true;
            data.terms_accepted = true;
            data.steps = [];

            // Step 1: uses main message_templates, delay 0
            const step1Media = document.getElementById('mediaData_1').value;
            data.steps.push({
                step_number: 1,
                step_label: 'Mensagem Inicial',
                message_templates: messageTemplates,
                delay_days: 0,
                media_base64: step1Media || null,
                media_name: document.getElementById('mediaName_1').value || null,
                media_type: document.getElementById('mediaType_1').value || null
            });

            // Steps 2-4: separate messages
            const stepLabels = { 2: 'Follow-up 1', 3: 'Follow-up 2', 4: 'Break-up' };
            for (let s = 2; s <= 4; s++) {
                const msg = document.getElementById(`msg_step_${s}`).value.trim();
                const delay = parseInt(document.getElementById(`delay_step_${s}`).value) || 3;
                const mediaB64 = document.getElementById(`mediaData_${s}`).value;
                data.steps.push({
                    step_number: s,
                    step_label: stepLabels[s],
                    message_templates: [msg],
                    delay_days: delay,
                    media_base64: mediaB64 || null,
                    media_name: document.getElementById(`mediaName_${s}`).value || null,
                    media_type: document.getElementById(`mediaType_${s}`).value || null
                });
            }
        }

        // Multi-instance support (super admin only)
        // Instance Validation (Required for everyone)
        const instanceCheckboxes = document.querySelectorAll('input[name="instance_ids"]:checked');
        if (instanceCheckboxes.length === 0) {
            alert('Selecione pelo menos uma inst√¢ncia de WhatsApp.');
            btn.disabled = false;
            btn.innerHTML = originalText;
            return;
        }

        const instanceIds = Array.from(instanceCheckboxes).map(cb => parseInt(cb.value));
        data.instance_ids = instanceIds;

        // Rotation mode (only if toggle exists, default single)
        const rotationToggle = document.getElementById('rotation_toggle');
        if (rotationToggle && rotationToggle.checked) {
            data.rotation_mode = 'round_robin';
        } else {
            data.rotation_mode = 'single';
        }

        try {
            const res = await fetch('/api/campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const json = await res.json();

            if (res.ok) {
                feedback.textContent = `Sucesso! Campanha criada com ${json.leads_count} leads.`;
                feedback.className = 'text-center mt-4 text-sm font-medium text-green-400';
                feedback.classList.remove('hidden');

                // Redirect after short delay
                setTimeout(() => {
                    window.location.href = '/campaigns';
                }, 1500);
            } else {
                throw new Error(json.error || 'Erro desconhecido');
            }

        } catch (err) {
            feedback.textContent = `Erro: ${err.message}`;
            feedback.className = 'text-center mt-4 text-sm font-medium text-red-400';
            feedback.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
    // --- Template Management ---

    async function loadTemplates() {
        const select = document.getElementById('loadTemplateSelect');
        try {
            const res = await fetch('/api/templates');
            const templates = await res.json();

            select.innerHTML = '<option value="">üìÇ Carregar Modelo...</option>';
            templates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.content; // Storing content in value for simplicity
                opt.textContent = t.name;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error('Erro ao carregar templates:', err);
        }
    }

    document.getElementById('loadTemplateSelect').addEventListener('change', (e) => {
        const content = e.target.value;
        if (!content) return;

        // Find best place to insert
        const allTextareas = Array.from(document.querySelectorAll('.template-input'));
        let target = allTextareas.find(t => !t.value.trim()); // First empty

        if (!target) {
            // If all full, add new if possible
            if (allTextareas.length < maxTemplates) {
                addBtn.click();
                // Wait for DOM
                setTimeout(() => {
                    const newTextareas = document.querySelectorAll('.template-input');
                    target = newTextareas[newTextareas.length - 1];
                    target.value = content;
                }, 50);
                e.target.value = ""; // Reset select
                return;
            } else {
                target = allTextareas[allTextareas.length - 1]; // Overwrite last
            }
        }

        target.value = content;
        e.target.value = ""; // Reset select
    });

    document.getElementById('saveTemplateBtn').addEventListener('click', async () => {
        // Get content from first valid textarea
        const allTextareas = Array.from(document.querySelectorAll('.template-input'));
        const content = allTextareas.find(t => t.value.trim())?.value;

        if (!content) {
            alert('Digite uma mensagem para salvar.');
            return;
        }

        const name = prompt('Nome do Modelo (ex: Prospec√ß√£o Dentista):');
        if (!name) return;

        try {
            const res = await fetch('/api/templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, content })
            });

            if (res.ok) {
                alert('Modelo salvo com sucesso!');
                loadTemplates(); // Reload dropdown
            } else {
                alert('Erro ao salvar modelo.');
            }
        } catch (err) {
            alert('Erro: ' + err.message);
        }
    });

    // Initialize
    loadTemplates();

    // ============================================================
    // CADENCE FUNCTIONS
    // ============================================================

    // Toggle cadence on/off
    function toggleCadence() {
        const track = document.getElementById('cadenceToggle');
        const hidden = document.getElementById('enable_cadence');
        const stepsContainer = document.getElementById('cadenceStepsContainer');
        const isOn = track.classList.toggle('on');
        hidden.value = isOn ? 'true' : 'false';
        stepsContainer.style.display = isOn ? 'block' : 'none';
        // Terms card stays always visible ‚Äî no toggle needed
    }

    // Expand/collapse a step
    function toggleStep(stepNum) {
        const body = document.querySelector(`[data-step-body="${stepNum}"]`);
        const chevron = document.querySelector(`.step-chevron[data-step="${stepNum}"]`);
        const isOpen = body.classList.toggle('open');
        if (chevron) {
            chevron.style.transform = isOpen ? 'rotate(180deg)' : '';
        }
    }

    // Handle media file selection ‚Üí encode as base64 + show preview
    function handleMediaUpload(stepNum, input) {
        const file = input.files[0];
        if (!file) return;

        // Validate size (max 16MB)
        if (file.size > 16 * 1024 * 1024) {
            alert('Arquivo muito grande. M√°ximo: 16MB.');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const base64Full = e.target.result; // data:mime;base64,xxxx
            const base64Data = base64Full.split(',')[1]; // just the base64 part
            const mimeType = file.type;

            // Store in hidden fields
            document.getElementById(`mediaData_${stepNum}`).value = base64Data;
            document.getElementById(`mediaName_${stepNum}`).value = file.name;
            document.getElementById(`mediaType_${stepNum}`).value = mimeType.startsWith('video') ? 'video' : 'image';

            // Show preview
            const preview = document.getElementById(`mediaPreview_${stepNum}`);
            const thumb = document.getElementById(`mediaThumb_${stepNum}`);

            if (mimeType.startsWith('image')) {
                thumb.src = base64Full;
                thumb.style.display = 'block';
            } else {
                thumb.src = '';
                thumb.style.display = 'none';
                // Add a video icon indicator instead
                preview.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-gray-800/50 rounded-lg border border-gray-600/30">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        <span class="text-xs text-gray-300">${file.name}</span>
                        <button type="button" onclick="removeMedia(${stepNum})" class="text-xs text-red-400 hover:text-red-300">‚úï</button>
                    </div>`;
            }
            preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Remove media from a step
    function removeMedia(stepNum) {
        document.getElementById(`mediaData_${stepNum}`).value = '';
        document.getElementById(`mediaName_${stepNum}`).value = '';
        document.getElementById(`mediaType_${stepNum}`).value = '';
        document.getElementById(`mediaPreview_${stepNum}`).classList.add('hidden');

        const thumb = document.getElementById(`mediaThumb_${stepNum}`);
        if (thumb) {
            thumb.src = '';
            // Restore original preview structure
            const preview = document.getElementById(`mediaPreview_${stepNum}`);
            preview.innerHTML = `
                <img id="mediaThumb_${stepNum}" class="media-preview" src="" alt="">
                <button type="button" onclick="removeMedia(${stepNum})" class="text-xs text-red-400 hover:text-red-300">‚úï</button>`;
        }

        // Reset file input
        const fileInput = document.getElementById(`media_step_${stepNum}`);
        if (fileInput) fileInput.value = '';
    }

    // Generate AI copy for a cadence step
    async function generateCadenceCopy(stepNum) {
        const businessContext = document.getElementById('business_context').value.trim();
        if (!businessContext) {
            alert('Descreva seu neg√≥cio no campo acima para a IA gerar mensagens.');
            document.getElementById('business_context').focus();
            return;
        }

        const textarea = document.getElementById(`msg_step_${stepNum}`);
        if (!textarea) return;

        const stepLabels = { 2: 'follow-up 1', 3: 'follow-up 2', 4: 'break-up (√∫ltima tentativa)' };
        const stepLabel = stepLabels[stepNum] || 'mensagem';

        const originalPlaceholder = textarea.placeholder;
        textarea.disabled = true;
        textarea.placeholder = '‚ú® IA gerando mensagem de ' + stepLabel + '...';

        try {
            const res = await fetch('/api/ai/generate-copy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    business_context: businessContext + `\n\nGere uma mensagem de ${stepLabel}. O lead j√° recebeu mensagens anteriores e n√£o respondeu. Seja breve e direto.`
                })
            });
            const data = await res.json();
            if (res.ok && data.message) {
                textarea.value = data.message;
                textarea.style.borderColor = '#10b981';
                setTimeout(() => { textarea.style.borderColor = ''; }, 1000);
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        } catch (err) {
            alert(`Erro ao gerar copy: ${err.message}`);
        } finally {
            textarea.placeholder = originalPlaceholder;
            textarea.disabled = false;
        }
    }

    // Terms checkbox controls submit state ‚Äî always required
    function updateSubmitState() {
        const submitBtn = document.getElementById('submitBtn');
        const termsCheckbox = document.getElementById('termsAccepted');
        submitBtn.disabled = !termsCheckbox.checked;
        submitBtn.style.opacity = termsCheckbox.checked ? '1' : '0.5';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const termsCheckbox = document.getElementById('termsAccepted');
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', updateSubmitState);
        }
        // Initialize: button starts disabled until terms accepted
        updateSubmitState();
    });

</script>
{% endblock %}